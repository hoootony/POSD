<html>
	<head>
	<link href="../../third-party/google-code-prettify\prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	<script type="text/javascript" src="../../third-party/google-code-prettify\prettify.js"></script>
	</head>
	<title>
		presentationmodel.cpp
	</title>
	<body onload="prettyPrint()">
		<pre class="prettyprint lang-cpp linenums">#include "PresentationModel.h"
#include "EditComponentCommand.h"
#include "ChangeParentCommand.h"
#include "DeleteComponentCommand.h"
#include "GraphicsNode.h"

PresentationModel::PresentationModel()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionNew"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionSave"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionLoad"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionEdit"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionDelete"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Child"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Sibling"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Parent"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCut"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCopy"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionPaste"] = false;</span>
<span style = "background-color:#fdd">	_isPaste = false;</span>
<span style = "background-color:#fdd">}</span>

PresentationModel::~PresentationModel()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">}</span>

string PresentationModel::showMap()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _model.showMap();</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::setInsertMode(string mode) //³]©w´¡¤J¸`ÂIªº¼Ò¦¡
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	if (mode.compare("a") == 0) //¤÷¥À¿Ë</span>
	{
<span style = "background-color:#fdd">		_insertMode = "Parent";</span>
	}
<span style = "background-color:#fdd">	else if (mode.compare("b") == 0) //¤p«Ä</span>
	{
<span style = "background-color:#fdd">		_insertMode = "Child";</span>
	}
<span style = "background-color:#fdd">	else if (mode.compare("c") == 0) //¥S§Ì©n©f</span>
	{
<span style = "background-color:#fdd">		_insertMode = "Sibling";</span>
	}
<span style = "background-color:#fdd">	else</span>
	{
<span style = "background-color:#fdd">		_insertMode = mode;</span>
<span style = "background-color:#fdd">		return false;</span>
	}
<span style = "background-color:#fdd">	return true;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::insertNode(string description)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	if (description.compare("") == 0 || _model.getMindMap().size() == 0)</span>
<span style = "background-color:#fdd">		return;</span>
<span style = "background-color:#fdd">	_model.insertNode(description, _insertMode);</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::createMindMap(string description)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	if (description.compare("") == 0)</span>
<span style = "background-color:#fdd">		return;</span>
<span style = "background-color:#fdd">	_model.createMindMap(description); </span>
<span style = "background-color:#fdd">	setGuiSelectNull();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::selectComponent(int id)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	if (!_model.isNodeExist(id))</span>
<span style = "background-color:#fdd">		return;</span>

<span style = "background-color:#fdd">	if (_model.isRoot(id)) setGuiRootEdit();</span>
<span style = "background-color:#fdd">	else setGuiNodeEdit();</span>

<span style = "background-color:#fdd">	_model.selectComponent(id);</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::saveMindMapFile(string path)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _model.saveMindMapFile(path);</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::readMindMapFile(string path)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	setGuiLoaded(); </span>
<span style = "background-color:#fdd">	setGuiSelectNull();</span>
<span style = "background-color:#fdd">	return _model.readMindMapFile(path);</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::undo()
<span style = "background-color:#fdd">{</span>
	//return _commandManger.undo();
<span style = "background-color:#fdd">	return _model.undo();</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::redo()
<span style = "background-color:#fdd">{</span>
	//return _commandManger.redo();
<span style = "background-color:#fdd">	return _model.redo();</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::isNodeExist(int id)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _model.isNodeExist(id);</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::isRoot(int id)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _model.isRoot(id);</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::changeParentCommand(int myselfId, int newParentId)
<span style = "background-color:#fdd">{</span>
	//selectComponent(myselfId);
	//Component *myself = _model.getComponent();
	//selectComponent(newParentId);
	//Component *newParent = _model.getComponent();
	//_commandManger.execute(new ChangeParentCommand(&amp;_model, myself, newParent));
<span style = "background-color:#fdd">	_model.changeParentCommand(myselfId, newParentId);</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::editDescriptionCommand(int id, string description)
<span style = "background-color:#fdd">{</span>
	//selectComponent(id);
	//_commandManger.execute(new EditComponentCommand(&amp;_model, _model.getComponent(), description));
<span style = "background-color:#fdd">	_model.editDescriptionCommand(id, description); </span>
<span style = "background-color:#fdd">	setGuiSelectNull();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::deleteComponentCommand(int id)
<span style = "background-color:#fdd">{</span>
	//selectComponent(id);
	//_commandManger.execute(new DeleteComponentCommand(&amp;_model, _model.getComponent()));
<span style = "background-color:#fdd">	_model.deleteComponentCommand(id);</span>
<span style = "background-color:#fdd">	setGuiSelectNull();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::showGuiMap(QGraphicsScene *scene, QMainWindow *parent)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_model.showGuiMap();</span>
<span style = "background-color:#fdd">	list&lt;Component *&gt; mindMap = _model.getMindMap();</span>
	
<span style = "background-color:#fdd">	for (list&lt;Component *&gt;::iterator it = mindMap.begin(); it != mindMap.end(); ++it)</span>
	{
<span style = "background-color:#fdd">		if ((*it)-&gt;getType() == "Root" || (*it)-&gt;getParent() != NULL)</span>
		{
<span style = "background-color:#fdd">			qreal x = (*it)-&gt;getX() * (GraphicsNode::WIDTH + GraphicsNode::AFTER_SPACE);</span>
<span style = "background-color:#fdd">			qreal y = (*it)-&gt;getY() * (GraphicsNode::HEIGH + GraphicsNode::AFTER_SPACE);</span>
<span style = "background-color:#fdd">			QGraphicsItem *qNode = new GraphicsNode(x, y, (*it), this, parent);</span>
<span style = "background-color:#fdd">			scene-&gt;addItem(qNode);</span>
<span style = "background-color:#fdd">			if ((*it)-&gt;getType() != "Root")</span>
<span style = "background-color:#fdd">				scene-&gt;addLine(x, y + GraphicsNode::HEIGH / 2, (*it)-&gt;getParent()-&gt;getX()* (GraphicsNode::WIDTH + GraphicsNode::AFTER_SPACE) + GraphicsNode::WIDTH, (*it)-&gt;getParent()-&gt;getY()* (GraphicsNode::HEIGH + GraphicsNode::AFTER_SPACE) + GraphicsNode::HEIGH / 2);</span>

			//for debug use cout
			//cout &lt;&lt; "Description:" &lt;&lt; (*it)-&gt;getDescription() &lt;&lt; ", X:" &lt;&lt; (*it)-&gt;getX() &lt;&lt; ", Y:" &lt;&lt; (*it)-&gt;getY() &lt;&lt; endl;
<span style = "background-color:#fdd">		}</span>
<span style = "background-color:#fdd">	}</span>
	//cout &lt;&lt; _model.showMap();
<span style = "background-color:#fdd">}</span>

bool PresentationModel::isActionEnabled(string actionName)
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _actionEnabled[actionName];</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::clearSelect()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_model.clearSelect();</span>
<span style = "background-color:#fdd">	setGuiSelectNull();</span>
<span style = "background-color:#fdd">}</span>

int PresentationModel::getSelectNodeId()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	return _model.getComponent()-&gt;getId();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiRootEdit()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionEdit"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionDelete"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Child"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Sibling"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Parent"] = false;</span>
	//cut, copy, paste
<span style = "background-color:#fdd">	_actionEnabled["actionCut"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCopy"] = false;</span>
<span style = "background-color:#fdd">	setGuiPaste();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiNodeEdit()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionEdit"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionDelete"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Child"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Sibling"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Parent"] = true;</span>
<span style = "background-color:#fdd">	setGuiCutAndCopy();</span>
<span style = "background-color:#fdd">	setGuiPaste();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiLoaded()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionNew"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionSave"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionLoad"] = true;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiSelectNull()
<span style = "background-color:#fdd">{</span>
	//edit menu
<span style = "background-color:#fdd">	_actionEnabled["actionEdit"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionDelete"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Child"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Sibling"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionInsert_a_Parent"] = false;</span>
	//cut, copy, paste
<span style = "background-color:#fdd">	_actionEnabled["actionCut"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCopy"] = false;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionPaste"] = false;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiCutAndCopy()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCut"] = true;</span>
<span style = "background-color:#fdd">	_actionEnabled["actionCopy"] = true;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::setGuiPaste()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_actionEnabled["actionPaste"] = _isPaste;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::refreshUI()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	notify();</span>
<span style = "background-color:#fdd">}</span>

bool PresentationModel::haveCreateMindMap()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	if (_model.getMindMap().size() == 0)</span>
<span style = "background-color:#fdd">		return false;</span>
<span style = "background-color:#fdd">	return true;</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::cutNode()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_model.cutNode();</span>
<span style = "background-color:#fdd">	_isPaste = true;</span>
<span style = "background-color:#fdd">	setGuiPaste();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::copyNode()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_model.copyNode();</span>
<span style = "background-color:#fdd">	_isPaste = true;</span>
<span style = "background-color:#fdd">	setGuiPaste();</span>
<span style = "background-color:#fdd">}</span>

void PresentationModel::pasteNode()
<span style = "background-color:#fdd">{</span>
<span style = "background-color:#fdd">	_model.pasteNode();</span>
<span style = "background-color:#fdd">	_isPaste = false;</span>
<span style = "background-color:#fdd">	setGuiPaste();</span>
<span style = "background-color:#fdd">}</span>
</pre>
	</body>
</html>